Ext.ns("Ext.ux.grid");
Ext.ux.grid.CollectGrid=Ext.extend(Ext.grid.GridPanel,{keepSelectedOnPaging:!1,recordIds:null,idColName:"",url:"",rowNumber:!0,checkBox:!0,CM_JR_Record:null,pagingBar:!0,pageSize:20,pageCloseButton:!0,selfParams:null,toolbar:!0,loadMask:!0,toolbarConfig:null,isSummary:!1,stripeRows:!0,isSingleSelect:!1,isRemoteSort:!0,clearCheckBoxHeader:!1,sortType:"ASC",filterValue:"",filterTxt:"",dateFilter:"",endDate:"",startDate:"",sortField:"",showGridData:!0,doRefresh:null,enablePageRemove:!1,radiobox:!1,viewConfig:{forceFit:!0},
pagingConfig:{displayInfo:!0,displayMsg:"\u5f53\u524d {0} - {1} \u603b\u8ba1: {2}&nbsp;&nbsp;",emptyMsg:"<b>0</b> "},initComponent:function(){this.recordIds=[];Ext.applyIf(this,{urlAddData:"addData.do",urlDeleteData:"deleteData.do",urlUpdateData:"updateData.do",urlLoadData:this.url});this.CM_JR_Record&&this.init_SM_CM_DS();this.toolbar&&this.init_Toolbar();this.pagingBar&&this.init_PagingBar();this.keepSelectedOnPaging&&this.init_OnPaging();this.setupAltAKey();this.showGridData&&(this.pagingBar?this.refresh():
this.store.load());Ext.ux.grid.CollectGrid.superclass.initComponent.call(this)},init_SM_CM_DS:function(){if(this.isSummary)this.plugins=new Ext.ux.grid.GridSummary;var b=[],a=[];this.rowNumber&&(b[b.length]=new Ext.grid.RowNumberer({header:"\u5e8f\u53f7",width:35,align:"center"}));if(this.radiobox){var c=new Ext.grid.RadioboxSelectionModel({listeners:{selectionchange:this.selectionChangeAction.createDelegate(this)}});this.selModel=b[b.length]=c}else if(this.checkBox)c={handleMouseDown:Ext.emptyFn,
singleSelect:this.isSingleSelect,listeners:{selectionchange:this.selectionChangeAction.createDelegate(this)}},this.clearCheckBoxHeader&&Ext.apply(c,{header:""}),c=new Ext.grid.CheckboxSelectionModel(c),this.selModel=b[b.length]=c;for(c=0;c<this.CM_JR_Record.length;c++){var d=this.CM_JR_Record[c];if(d.gridShow||d.gridShow=="undefined"||d.gridShow==null)if(d.isProgress){var e=new Ext.ux.grid.ProgressColumn({header:d.header,dataIndex:d.dataIndex,width:d.width,textPst:"%",actionEvent:"click",colored:!0,
editor:new Ext.form.TextField});b[b.length]=e}else b[b.length]=d;a[a.length]={name:d.dataIndex,type:d.type||"string"}}this.cm=new Ext.grid.ColumnModel(b);if(this.url)this.store=this.sortField!=""?new Ext.data.Store({remoteSort:this.isRemoteSort,sortInfo:{field:this.sortField,direction:this.sortType},proxy:new Ext.data.HttpProxy({url:this.url,method:"post"}),reader:new Ext.data.JsonReader({totalProperty:"totalProperty",root:"result"},Ext.data.Record.create(a))}):new Ext.data.Store({remoteSort:this.isRemoteSort,
proxy:new Ext.data.HttpProxy({url:this.url,method:"post"}),reader:new Ext.data.JsonReader({totalProperty:"totalProperty",root:"result"},Ext.data.Record.create(a))}),this.pagingConfig.store=this.store,this.setBaseParams()},doFilter:function(){this.store.baseParams={filterValue:"",filterTxt:"",dateFilter:"",startDate:"",endDate:""}},setBaseParams:function(){this.store.on("beforeload",function(){this.filterValue==""&&this.filterTxt==""&&this.dateFilter==""&&this.startDate==""&&this.endDate==""&&this.sortField==
""?this.doFilter():Ext.apply(this.store.baseParams,{filterValue:this.filterValue,filterTxt:this.filterTxt,dateFilter:this.dateFilter,startDate:this.startDate,endDate:this.endDate,sort:this.sortField,dir:this.sortType});this.selfParams&&Ext.apply(this.store.baseParams,this.selfParams)}.createDelegate(this))},init_Toolbar:function(){if(this.toolbarConfig!=null)for(var b=0;b<this.toolbarConfig.length;b++){var a=this.toolbarConfig[b],c=!1;if(a.itemEName!=void 0&&a.itemEName!="undefined"&&a.itemEName!=
"")for(x=0;x<personButtonArray.length;x++)a.itemEName==personButtonArray[x]&&(c=!0);else c=!0;if(c==!0||c=="true")if(Ext.util.JSON.encode(a.id).substring(1,4)=="add"||a.buttonType=="add")this.toolbarConfig[b]={id:a.id,text:a.text?a.text:"\u65b0\u589e",tooltip:a.tooltip?a.tooltip:"\u65b0\u589e\u6570\u636e",iconCls:a.iconCls?a.iconCls:"add",handler:this.addData.createDelegate(this)};else if(Ext.util.JSON.encode(a.id).substring(1,5)=="save"||a.buttonType=="save")this.toolbarConfig[b]={id:a.id,text:a.text?
a.text:"\u4fdd\u5b58",tooltip:a.tooltip?a.tooltip:"\u4fdd\u5b58\u6570\u636e",iconCls:a.iconCls?a.iconCls:"save",handler:this.onSave,scope:this};else if(Ext.util.JSON.encode(a.id).substring(1,7)=="update"||a.buttonType=="update")this.toolbarConfig[b]={id:a.id,text:a.text?a.text:"\u4fee\u6539",tooltip:a.tooltip?a.tooltip:"\u4fee\u6539\u6570\u636e",iconCls:a.iconCls?a.iconCls:"edit",handleNumType:"single",disabled:!0,handler:this.updateData.createDelegate(this)},this.updateButton=this.toolbarConfig[b];
else if(Ext.util.JSON.encode(a.id).substring(1,7)=="select"||a.buttonType=="select")this.toolbarConfig[b]={id:a.id,text:a.text?a.text:"\u9ad8\u7ea7\u67e5\u8be2",tooltip:a.tooltip?a.tooltip:"\u9ad8\u7ea7\u67e5\u8be2",iconCls:a.iconCls?a.iconCls:"select",handler:this.selectData.createDelegate(this)};else if(Ext.util.JSON.encode(a.id).substring(1,7)=="delete"||a.buttonType=="delete")this.toolbarConfig[b]={id:a.id,text:a.text?a.text:"\u5220\u9664",tooltip:a.tooltip?a.tooltip:"\u5220\u9664\u6570\u636e",
iconCls:a.iconCls?a.iconCls:"delete",disabled:!0,handleNumType:"multitude",handler:this.deleteData.createDelegate(this)},this.removeButton=this.toolbarConfig[b];else{if(a.handleNumType)a.disabled=!0;this.toolbarConfig[b]=a}else this.toolbarConfig[b]=""}this.tbar=new Ext.Toolbar({enableOverflow:!0,items:this.toolbarConfig})},setupAltAKey:function(){this.on("afterrender",function(){this.body.on("keyup",function(b){b.getKey()==65&&b.altKey&&this.addData()},this)},this)},addData:function(){},updateData:function(){this.addData()},
selectData:function(){},deleteData:function(){this.getSelected().length==0?Ext.Msg.show({title:"\u63d0\u793a",width:250,closable:!1,msg:" \u8bf7\u9009\u4e2d\u8981\u5220\u9664\u7684\u6570\u636e",buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO}):Ext.Msg.show({title:"\u63d0\u793a",width:250,closable:!1,fn:this.deleteRecords.createDelegate(this),msg:" \u786e\u5b9a\u8981\u5220\u9664\u8fd9\u4e9b\u6570\u636e\u5417?",buttons:Ext.Msg.YESNO,icon:Ext.MessageBox.QUESTION})},deleteRecords:function(b){if(b=="yes"){Ext.MessageBox.show({title:"\u63d0\u793a",
msg:"\u4fe1\u606f\u5220\u9664\u4e2d...",progress:!0,width:300,wait:!0,closable:!0});b="";if(this.keepSelectedOnPaging&&this.enablePageRemove)b+=this.recordIds.join(",");else for(var a=this.getSelectionModel().getSelections(),c=0,d;d=a[c];c++)b+=d.get("id")+",";b={url:this.urlDeleteData,params:{ids:b},success:function(){Ext.MessageBox.hide();Ext.ux.LevitationMsgBox.msg("\u63d0\u793a","\u64cd\u4f5c\u6210\u529f\uff01");this.refresh();if(this.enablePageRemove&&this.keepSelectedOnPaging){this.clearRecordIdArray();
var a=this.getTopToolbar();(a.find("buttonType","update")[0]||Ext.getCmp(this.updateButton.id)).disable();(a.find("buttonType","update")[0]||Ext.getCmp(this.removeButton.id)).disable()}}.createDelegate(this),failure:function(){Ext.ux.LevitationMsgBox.msg("\u63d0\u793a","\u64cd\u4f5c\u5931\u8d25\uff01")}};Ext.Ajax.request(b)}},init_PagingBar:function(){Ext.apply(this.pagingConfig,{pageSize:this.pageSize});this.pageCloseButton?Ext.apply(this.pagingConfig,{items:["-",{iconCls:"cancel",tooltip:"\u5173\u95ed\u5f53\u524d\u6807\u7b7e",
handler:function(){this.findParentByType("tabpanel").getActiveTab().destroy()}}]}):Ext.apply(this.pagingConfig,{items:[]});var b={};Ext.apply(b,this.pagingConfig);this.doRefresh&&Ext.isFunction(this.doRefresh)&&Ext.apply(b,{doRefresh:this.doRefresh.createDelegate(this)});this.bbar=new Ext.PagingToolbar(b)},init_OnPaging:function(){this.idColName=this.CM_JR_Record[0].dataIndex;this.checkBox&&(this.selModel.on("rowdeselect",function(b,a,c){for(b=0;b<this.recordIds.length;b++)if(c.data[this.idColName]==
this.recordIds[b]){this.recordIds.splice(b,1);break}},this),this.selModel.on("rowselect",function(b,a,c){if(this.hasElement(this.recordIds))for(b=0;b<this.recordIds.length;b++)if(c.data[this.idColName]==this.recordIds[b])return;this.recordIds.unshift(c.data[this.idColName])},this));this.store.on("load",function(b){this.hasElement(this.recordIds)&&b.each(function(a){Ext.each(this.recordIds,function(b){if(a.data[this.idColName]==b)return this.selModel.selectRecords([a],!0),!1},this)},this)},this)},
hasElement:function(b){return b.length>0?!0:!1},refresh:function(){this.store.load({params:{start:0,limit:this.pageSize?this.pageSize:20},callback:function(b,a,c){c==!1&&Ext.ux.LevitationMsgBox.msg("\u63d0\u793a","\u65e0\u6cd5\u88c5\u8f7d\u6570\u636e\uff01")}})},clearRecordIdArray:function(){this.hasElement(this.recordIds)&&this.recordIds.splice(0,this.recordIds.length);this.getSelectionModel().clearSelections()},getSelected:function(){return this.keepSelectedOnPaging?this.recordIds:this.getSelectionModel().getSelections()},
selectionChangeAction:function(){var b=this.getTopToolbar();b&&Ext.each(b.findByType("button"),function(a){a.handleNumType&&(a.handleNumType=="single"?this.getSelected().length==1?a.enable():a.disable():a.handleNumType=="multitude"&&(this.getSelected().length!=0?a.enable():a.disable()))},this);this.isSummary&&this.plugins.refreshSummary()}});Ext.reg("collectgrid",Ext.ux.grid.CollectGrid);
